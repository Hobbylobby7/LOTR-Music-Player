<!DOCTYPE html>
<html>
<head>
    <title>LOTR Spotify Music Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: #f4f1de;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #d4af37;
            border-radius: 10px;
        }
        .title {
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .spotify-auth {
            text-align: center;
            padding: 20px;
            background: rgba(29, 185, 84, 0.2);
            border: 2px solid #1db954;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .auth-btn {
            background: #1db954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        .auth-btn:hover {
            background: #1ed760;
        }
        .player-hidden {
            display: none;
        }
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .category {
            background: rgba(0,0,0,0.4);
            border: 2px solid #8b7355;
            border-radius: 10px;
            padding: 15px;
        }
        .category h3 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 10px;
        }
        .music-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #2c3e50;
            color: #f4f1de;
            border: 1px solid #8b7355;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .music-btn:hover {
            background: #d4af37;
            color: #1a1a2e;
        }
        .music-btn.playing {
            background: #1db954;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .now-playing {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #000;
            border: 2px solid #1db954;
            border-radius: 10px;
            padding: 15px;
            display: none;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .control-btn {
            background: #2c3e50;
            color: #f4f1de;
            border: 2px solid #d4af37;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .control-btn:hover {
            background: #d4af37;
            color: #1a1a2e;
        }
        .control-btn:disabled {
            background: #666;
            border-color: #999;
            cursor: not-allowed;
        }
        .instructions {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .debug-info {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">LOTR Spotify Music Player</h1>
        <p>Real Howard Shore music for your D&D campaign!</p>
    </div>

    <div class="spotify-auth" id="authSection">
        <h3>üéµ Connect to Spotify</h3>
        <p>To play the actual Howard Shore LOTR soundtrack:</p>
        <button class="auth-btn" onclick="loginSpotify()">Connect Spotify Premium</button>
        <div class="instructions">
            <strong>Requirements:</strong><br>
            ‚Ä¢ Spotify Premium account<br>
            ‚Ä¢ You've been added as an authorized user<br>
            ‚Ä¢ Web Playback SDK enabled in your app
        </div>
        <div class="debug-info" id="debugInfo">
            Loading...
        </div>
    </div>

    <div id="playerSection" class="player-hidden">
        <div class="controls">
            <button class="control-btn" onclick="pauseTrack()">‚è∏Ô∏è Pause</button>
            <button class="control-btn" onclick="resumeTrack()">‚ñ∂Ô∏è Resume</button>
            <button class="control-btn" onclick="previousTrack()">‚èÆÔ∏è Previous</button>
            <button class="control-btn" onclick="nextTrack()">‚è≠Ô∏è Next</button>
        </div>

        <div class="music-grid">
            <div class="category">
                <h3>üè° The Shire</h3>
                <button class="music-btn" onclick="playSpotifyTrack('644es5aYPJghtZLjM1rmSP', this, 'Concerning Hobbits')">Concerning Hobbits</button>
                <button class="music-btn" onclick="playSpotifyTrack('1FJqKI6OnvNAOQsKKnySKR', this, 'The Shire')">The Shire</button>
                <button class="music-btn" onclick="playSpotifyTrack('3U2e31Gm6GJRKzc8GRaGdz', this, 'A Long Expected Party')">A Long Expected Party</button>
            </div>
            
            <div class="category">
                <h3>üó°Ô∏è Adventure</h3>
                <button class="music-btn" onclick="playSpotifyTrack('2ljBm7bQhMhkHmCJtGTJNy', this, 'The Fellowship')">The Fellowship</button>
                <button class="music-btn" onclick="playSpotifyTrack('5EXB5MjGCTGKEcAOwwqbGO', this, 'The Road Goes Ever On')">The Road Goes Ever On</button>
                <button class="music-btn" onclick="playSpotifyTrack('6WGQN9CJFnPdGZMvjm7A5d', this, 'A Journey in the Dark')">A Journey in the Dark</button>
            </div>
            
            <div class="category">
                <h3>üåü Rivendell</h3>
                <button class="music-btn" onclick="playSpotifyTrack('0dWdnNNPSaYV5bAWYH8o4N', this, 'Rivendell')">Rivendell</button>
                <button class="music-btn" onclick="playSpotifyTrack('7kGRzEHH7MuJ1v2dYfCfg4', this, 'The Council of Elrond')">The Council of Elrond</button>
                <button class="music-btn" onclick="playSpotifyTrack('5B3rPXbZJ4rJSB7mNMNF2V', this, 'Lothl√≥rien')">Lothl√≥rien</button>
            </div>
            
            <div class="category">
                <h3>‚öîÔ∏è Battle</h3>
                <button class="music-btn" onclick="playSpotifyTrack('3JFhzLFObC0VUoYZf0zyv5', this, 'The Fighting Uruk-hai')">The Fighting Uruk-hai</button>
                <button class="music-btn" onclick="playSpotifyTrack('3JKLXJJGNYmyNSr5j6zUeb', this, 'Amon Hen')">Amon Hen</button>
                <button class="music-btn" onclick="playSpotifyTrack('2t4VcSN9SiQvfGj8YCBvF8', this, 'The Bridge of Khazad-d√ªm')">The Bridge of Khazad-d√ªm</button>
            </div>
            
            <div class="category">
                <h3>üåã Evil</h3>
                <button class="music-btn" onclick="playSpotifyTrack('3VsWGk6X4RuGfxVa8zjm6z', this, 'The Shadow of the Past')">The Shadow of the Past</button>
                <button class="music-btn" onclick="playSpotifyTrack('1FJqKI6OnvNAOQsKKnySKR', this, 'The Ring Goes South')">The Ring Goes South</button>
                <button class="music-btn" onclick="playSpotifyTrack('5t6K7ZJcXFmvNhHF1J2m3L', this, 'The Nazg√ªl')">The Nazg√ªl</button>
            </div>
        </div>
    </div>

    <div class="now-playing" id="status">
        üéµ Now Playing: Nothing
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // Spotify configuration
        const CLIENT_ID = 'd7b86bbeb6e844f08803e19f404eedc3';
        const REDIRECT_URI = 'https://hobbylobby7.github.io/LOTR-Music-Player/';
        const SCOPES = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state';

        let player = null;
        let deviceId = null;
        let accessToken = null;
        let currentButton = null;

        // Debug function
        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.innerHTML += message + '<br>';
                console.log('DEBUG:', message);
            }
        }

        // Generate random string for PKCE
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        // Generate code challenge
        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // Check for authorization code or access token
        function checkForToken() {
            updateDebugInfo('Checking for authorization code or access token...');
            
            // First check for access token (if we already have one)
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            accessToken = hashParams.get('access_token');
            
            if (accessToken) {
                updateDebugInfo('‚úÖ Access token found in hash!');
                window.history.replaceState({}, document.title, window.location.pathname);
                initializeSpotifyPlayer();
                return true;
            }
            
            // Check for authorization code (from PKCE flow)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                updateDebugInfo('‚úÖ Authorization code found, exchanging for token...');
                exchangeCodeForToken(code);
                return true;
            }
            
            updateDebugInfo('‚ùå No access token or authorization code found');
            return false;
        }

        // Exchange authorization code for access token
        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            
            if (!codeVerifier) {
                updateDebugInfo('‚ùå No code verifier found');
                return;
            }
            
            updateDebugInfo('Exchanging code for access token...');
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    updateDebugInfo('‚úÖ Access token received!');
                    
                    // Clean up
                    localStorage.removeItem('code_verifier');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    initializeSpotifyPlayer();
                } else {
                    const errorData = await response.json();
                    updateDebugInfo('‚ùå Token exchange failed: ' + JSON.stringify(errorData));
                }
            } catch (error) {
                updateDebugInfo('‚ùå Token exchange error: ' + error.message);
            }
        }

        // Login function with PKCE
        async function loginSpotify() {
            updateDebugInfo('Starting Spotify login with PKCE...');
            
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store code verifier
            localStorage.setItem('code_verifier', codeVerifier);
            
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `code_challenge_method=S256&` +
                `code_challenge=${codeChallenge}`;
            
            updateDebugInfo('Redirecting to Spotify...');
            window.location.href = authUrl;
        }

        // Initialize Spotify Player
        function initializeSpotifyPlayer() {
            updateDebugInfo('Initializing Spotify Player...');
            
            if (!window.Spotify) {
                updateDebugInfo('‚ùå Spotify SDK not loaded yet, waiting...');
                setTimeout(initializeSpotifyPlayer, 1000);
                return;
            }
            
            player = new Spotify.Player({
                name: 'LOTR D&D Music Player',
                getOAuthToken: cb => { 
                    updateDebugInfo('Providing OAuth token to player...');
                    cb(accessToken); 
                },
                volume: 0.7
            });

            // Player ready
            player.addListener('ready', ({ device_id }) => {
                updateDebugInfo('‚úÖ Player ready! Device ID: ' + device_id);
                deviceId = device_id;
                showPlayerSection();
                updateStatus('Ready to play LOTR music! Click any track.');
            });

            // Player state changes
            player.addListener('player_state_changed', (state) => {
                if (!state) return;
                
                const track = state.track_window.current_track;
                const isPlaying = !state.paused;
                
                if (track) {
                    updateStatus(isPlaying ? `‚ô™ ${track.name}` : `‚è∏Ô∏è ${track.name} (Paused)`);
                }
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                updateDebugInfo('‚ùå Initialization error: ' + message);
            });

            player.addListener('authentication_error', ({ message }) => {
                updateDebugInfo('‚ùå Authentication error: ' + message);
            });

            player.addListener('account_error', ({ message }) => {
                updateDebugInfo('‚ùå Account error: ' + message);
            });

            // Connect to player
            updateDebugInfo('Connecting to Spotify...');
            player.connect();
        }

        // Show player section
        function showPlayerSection() {
            updateDebugInfo('Showing player interface...');
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('playerSection').classList.remove('player-hidden');
        }

        // Play Spotify track
        async function playSpotifyTrack(trackId, button, trackName) {
            updateDebugInfo(`üéµ Attempting to play: ${trackName}`);
            
            if (!deviceId || !accessToken) {
                updateDebugInfo('‚ùå No device or token available');
                alert('Player not ready! Check debug info and try refreshing.');
                return;
            }

            // Clear previous playing button
            if (currentButton) {
                currentButton.classList.remove('playing');
            }

            // Set new playing button
            currentButton = button;
            button.classList.add('playing');

            try {
                const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        uris: [`spotify:track:${trackId}`]
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    updateDebugInfo('‚úÖ Track started successfully');
                    updateStatus(`‚ô™ ${trackName}`);
                } else {
                    const errorText = await response.text();
                    updateDebugInfo(`‚ùå Failed to play: ${response.status} - ${errorText}`);
                    button.classList.remove('playing');
                    currentButton = null;
                }
            } catch (error) {
                updateDebugInfo(`‚ùå Network error: ${error.message}`);
                button.classList.remove('playing');
                currentButton = null;
            }
        }

        // Control functions
        async function pauseTrack() {
            if (player) await player.pause();
        }

        async function resumeTrack() {
            if (player) await player.resume();
        }

        async function previousTrack() {
            if (player) await player.previousTrack();
        }

        async function nextTrack() {
            if (player) await player.nextTrack();
        }

        // Update status
        function updateStatus(text) {
            const status = document.getElementById('status');
            status.textContent = 'üéµ ' + text;
            status.style.display = text.includes('Nothing') ? 'none' : 'block';
        }

        // Spotify SDK ready callback
        window.onSpotifyWebPlaybackSDKReady = () => {
            updateDebugInfo('üéµ Spotify SDK loaded and ready');
            if (accessToken) {
                initializeSpotifyPlayer();
            }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugInfo('üéµ Page loaded, starting LOTR Music Player...');
            updateDebugInfo('Client ID: ' + CLIENT_ID);
            updateDebugInfo('Redirect URI: ' + REDIRECT_URI);
            checkForToken();
        });

        // Also check when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !accessToken) {
                checkForToken();
            }
        });
    </script>
</body>
</html>
